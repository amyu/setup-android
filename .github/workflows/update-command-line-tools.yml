name: Update command-line-tools version

on:
  schedule:
    - cron: '0 0 * * 1' # Every Monday at 00:00 UTC
  workflow_dispatch:

jobs:
  update-command-line-tools-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v6

      - name: Get latest command-line-tools version
        id: get-version
        run: |
          PAGE_CONTENT=$(curl -s "https://developer.android.com/studio")
          VERSION=$(echo "$PAGE_CONTENT" | grep -oP 'commandlinetools-linux-\K[0-9]+(?=_latest\.zip)' | head -1)
          if [ -z "$VERSION" ]; then
            echo "Failed to extract command-line-tools version"
            exit 1
          fi
          echo "Latest version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Update action.yml and README.md
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"

          # Update command-line-tools-version default in action.yml
          sed -i -E "/command-line-tools-version:/,/default:/ s/(default: \")[^\"]+\"/\1${VERSION}\"/" action.yml
          echo "Updated action.yml command-line-tools-version to ${VERSION}"

          # Update command-line-tools-version value in README.md
          sed -i -E "s/(command-line-tools-version: )[0-9]+/\1${VERSION}/" README.md
          # Update the # default: comment for command-line-tools in README.md
          sed -i -E "/# default: [0-9]+/{ N; s/(# default: )[0-9]+(\n[^\n]*command-tools)/\1${VERSION}\2/ }" README.md
          echo "Updated README.md command-line-tools-version to ${VERSION}"

      - name: Commit and push changes
        id: push
        run: |
          BRANCH="update-command-line-tools-version"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -B "$BRANCH"
          git add action.yml README.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "Update command-line-tools version to ${{ steps.get-version.outputs.version }}"
            git push origin "$BRANCH" --force-with-lease
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        if: steps.push.outputs.changed == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const branch = '${{ steps.push.outputs.branch }}';
            const version = '${{ steps.get-version.outputs.version }}';
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open',
            });
            if (pulls.length > 0) {
              console.log(`PR already exists: ${pulls[0].html_url}`);
            } else {
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Update command-line-tools version to ${version}`,
                body: `Update default \`command-line-tools-version\` to \`${version}\`.\n\nSee https://developer.android.com/studio#command-line-tools-only`,
                head: branch,
                base: context.payload.repository.default_branch,
              });
              console.log(`Created PR: ${pr.html_url}`);
            }
